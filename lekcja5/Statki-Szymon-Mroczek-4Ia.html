<!DOCTYPE html>
<html lang="pl-PL">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.T.A.T.K.I. - Game of the Year Edition</title>
    <style>
        * {
            box-sizing: border-box;
        }

        .board {
            width: 500px;
            height: 500px;
            float: left;
            margin-left: 300px;
            margin-top: 100px;
        }

        .cell {
            border: 1px solid black;
            height: 50px;
            width: 50px;
            float: left;
        }

        .ship {
            background-color: rgb(26, 1, 66);
        }

        .prprpr {
            background-color: red;
        }

        #PlayerShips {
            width: 250px;
            padding: 10px;
        }

        .playerShip {
            margin-top: 30px;
            height: 50px;
        }

        .playerShip:hover {
            background-color: deeppink;
        }

        .outline {
            background-color: green;
        }

        #boardSpace {
            text-align: center;
            position: absolute;
            left: 100px;
            top: 100px;
        }

        #btnStart,
        #btnGenerate {
            width: 80px;
            height: 20px;
        }

        #title {
            text-align: center;
        }

        #workSpace {
            text-align: center;
        }

        .ship1 {
            width: 50px;
        }

        .ship2 {
            width: 100px;
        }

        .ship3 {
            width: 150px;
        }

        .ship4 {
            width: 200px;
        }
    </style>
</head>

<body>
    <script>
        let Player = [
            [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2]
        ]

        let board = [
            [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
            [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2]
        ]

        const BOARD_HEIGHT = 10 + 2
        const BOARD_WIDTH = 10 + 2

        const MAX_SHIPS_4 = 1
        const MAX_SHIPS_3 = 2
        const MAX_SHIPS_2 = 3
        const MAX_SHIPS_1 = 4
        const ALL_SHIPS_MAX = MAX_SHIPS_1 + MAX_SHIPS_2 + MAX_SHIPS_3 + MAX_SHIPS_4

        const SHOTS_TO_WIN = MAX_SHIPS_1 + MAX_SHIPS_2 * 2 + MAX_SHIPS_3 * 3 + MAX_SHIPS_4 * 4

        let canPlace = []
        let startPlacing = []
        let tlt = 0
        let trn = 0
        let playerWin = 0
        let botWin = 0

        let allCells = []
        for (let i = 1; i < BOARD_HEIGHT - 1; i++) {
            for (let j = 1; j < BOARD_WIDTH - 1; j++) {
                allCells.push(i + '-' + j)
            }
        }

        let allPlayerCells = []
        for (let i = 1; i < BOARD_HEIGHT - 1; i++) {
            for (let j = 1; j < BOARD_WIDTH - 1; j++) {
                allPlayerCells.push('P' + '-' + i + '-' + j)
            }
        }

        let all_placed_ships = 0
        let placed_ships_4 = 0
        let placed_ships_3 = 0
        let placed_ships_2 = 0
        let placed_ships_1 = 0

        let canPlayerShoot = allCells
        let canBotShoot = allPlayerCells


        // for (let i = 0; i < BOARD_HEIGHT; i++) {
        //     board.push([])
        //     for (let j = 0; j < BOARD_WIDTH; j++) {
        //         board[i].push(0)
        //     }
        // }


        function LoadShip(shipLength) {
            canPlace = []
            tlt = Math.floor(Math.random() * 2)

            if (tlt == 0) {
                for (let i = 0; i < BOARD_HEIGHT; i++) {
                    for (let j = 0; j < BOARD_WIDTH - shipLength; j++) {
                        let canLength = 0
                        for (let k = 0; k < shipLength; k++) {
                            if (board[i][j + k] == 0) {
                                canLength += 1
                            }
                        }
                        if (canLength == shipLength) {
                            canPlace.push(i + '-' + j)
                        }
                    }
                }


                let myRand = Math.floor(Math.random() * canPlace.length)
                let startShip = canPlace[myRand].split('-')
                // console.log(canPlace)
                // console.log("Statek poziomy", "|", "Długość: ", shipLength, "|", "Współrzędne: ", startShip[0], startShip[1])
                let x = parseInt(startShip[0])
                let y = parseInt(startShip[1])

                for (let j = -1; j < shipLength + 1; j++) {
                    board[x - 1][y + j] = 2
                    board[x][y + j] = 2
                    board[x + 1][y + j] = 2
                }

                for (let i = 0; i < shipLength; i++) {
                    board[x][y + i] = 1
                }

            } else {
                for (let i = 0; i < BOARD_HEIGHT - shipLength; i++) {
                    for (let j = 0; j < BOARD_WIDTH; j++) {
                        let canLength = 0
                        for (let k = 0; k < shipLength; k++) {
                            if (board[i + k][j] == 0) {
                                canLength += 1
                            }
                        }
                        if (canLength == shipLength) {
                            canPlace.push(i + '-' + j)
                        }
                    }
                }


                let myRand = Math.floor(Math.random() * canPlace.length)
                let startShip = canPlace[myRand].split('-')
                // console.log(canPlace)
                // console.log("Statek pionowy", "|", "Długość: ", shipLength, "|", "Współrzędne", startShip[0], startShip[1])
                let x = parseInt(startShip[0])
                let y = parseInt(startShip[1])

                for (let j = -1; j < shipLength + 1; j++) {
                    board[x + j][y - 1] = 2
                    board[x + j][y] = 2
                    board[x + j][y + 1] = 2
                }

                for (let i = 0; i < shipLength; i++) {
                    board[x + i][y] = 1
                }

                canPlace = []

            }
        }



        function genBoard() {
            for (let i = 0; i < 1; i++) {
                LoadShip(4)
            }

            for (let i = 0; i < 2; i++) {
                LoadShip(3)
            }

            for (let i = 0; i < 3; i++) {
                LoadShip(2)
            }

            for (let i = 0; i < 4; i++) {
                LoadShip(1)
            }

            for (let i = 1; i < BOARD_HEIGHT - 1; i++) {
                for (let j = 1; j < BOARD_WIDTH - 1; j++) {
                    let div = document.createElement("div")
                    div.setAttribute('id', i + '-' + j)
                    div.classList.add('cell')
                    document.getElementById('opBoard').append(div)
                }
            }
            document.getElementById('btnGenerate').remove()
        }



        function PlayerBoard() {
            for (let i = 1; i < BOARD_HEIGHT - 1; i++) {
                for (let j = 1; j < BOARD_WIDTH - 1; j++) {
                    let div = document.createElement("div")
                    div.setAttribute('id', 'P' + '-' + i + '-' + j)
                    div.setAttribute('name', 'cell')
                    div.classList.add('cell')
                    document.getElementById('plBoard').append(div)
                }
            }
            document.getElementById('btnStart').remove()
            document.getElementById('title').innerText = ''


            for (let i = 1; i <= MAX_SHIPS_4; i++) {
                let ship4 = document.createElement('div')
                ship4.setAttribute('id', 'ship4_' + i)
                ship4.setAttribute('name', 'PickShip')
                ship4.setAttribute('onclick', 'PlayerShip(4)')
                ship4.classList.add('playerShip')
                ship4.classList.add('ship4')
                for (let i = 0; i < 4; i++) {
                    let ShipCell = document.createElement('div')
                    ShipCell.classList.add('cell')
                    ship4.append(ShipCell)
                } document.getElementById('PlayerShips').append(ship4)
            }

            for (let i = 1; i <= MAX_SHIPS_3; i++) {
                let ship3 = document.createElement('div')
                ship3.setAttribute('id', 'ship3_' + i)
                ship3.setAttribute('onclick', 'PlayerShip(3)')
                ship3.classList.add('playerShip')
                ship3.classList.add('ship3')
                for (let i = 0; i < 3; i++) {
                    let ShipCell = document.createElement('div')
                    ShipCell.classList.add('cell')
                    ship3.append(ShipCell)
                } document.getElementById('PlayerShips').append(ship3)
            }

            for (let i = 1; i <= MAX_SHIPS_2; i++) {
                let ship2 = document.createElement('div')
                ship2.setAttribute('id', 'ship2_' + i)
                ship2.setAttribute('onclick', 'PlayerShip(2)')
                ship2.classList.add('playerShip')
                ship2.classList.add('ship2')
                for (let i = 0; i < 2; i++) {
                    let ShipCell = document.createElement('div')
                    ShipCell.classList.add('cell')
                    ship2.append(ShipCell)
                } document.getElementById('PlayerShips').append(ship2)
            }

            for (let i = 1; i <= MAX_SHIPS_1; i++) {
                let ship1 = document.createElement('div')
                ship1.setAttribute('id', 'ship1_' + i)
                ship1.setAttribute('onclick', 'PlayerShip(1)')
                ship1.classList.add('playerShip')
                ship1.classList.add('ship1')
                for (let i = 0; i < 1; i++) {
                    let ShipCell = document.createElement('div')
                    ShipCell.classList.add('cell')
                    ship1.append(ShipCell)
                } document.getElementById('PlayerShips').append(ship1)
            }
        }



        function PlayerShip(shipLength) {
            let overBorder = 0
            canPlace = []
            for (let i = 0; i < BOARD_HEIGHT; i++) {
                for (let j = 0; j < BOARD_WIDTH - shipLength; j++) {
                    let canLength = 0
                    for (let k = 0; k < shipLength; k++) {
                        if (Player[i][j + k] == 0) {
                            canLength += 1
                        }
                    }
                    if (canLength == shipLength) {
                        canPlace.push('P' + '-' + i + '-' + j)
                    }
                }
            }

            // startPlacing = []
            // for (let i = 1; i < BOARD_HEIGHT - 1; i++) {
            //     for (let j = 1; j < BOARD_WIDTH - shipLength; j++) {
            //         startPlacing.push('P' + '-' + i + '-' + j)
            //     }
            // }

            // console.log(canPlace)
            // console.log(Player)

            function ShipOutline(e) {
                if (allPlayerCells.includes(e.target.id)) {
                    let cell_id = e.target.id.split('-')
                    let x = cell_id[1]
                    let y = parseInt(cell_id[2])
                    if (canPlace.includes(e.target.id)) {
                        for (let i = 0; i < shipLength; i++) {
                            let z = y + i
                            document.getElementById('P' + '-' + x + '-' + z).classList.add('outline')
                        }
                    } else {
                        let placeBorder = 0
                        // for (let i = 0; i < shipLength; i++) {
                        //     if (Player[x][BOARD_WIDTH - 1 - i] > 0) {
                        //         placeBorder++
                        //     }
                        // }
                        if (y + shipLength > BOARD_WIDTH - 1 && placeBorder == 0) {
                            for (let i = 0; i < shipLength; i++) {
                                let z = BOARD_WIDTH - 2 - i
                                document.getElementById('P' + '-' + x + '-' + z).classList.add('outline')
                            }
                        } else {
                            for (let i = 0; i < shipLength; i++) {
                                let z = y + i
                                document.getElementById('P' + '-' + x + '-' + z).classList.add('prprpr')
                            }
                        }
                    }
                }
            }

            function OutlineLeave(e) {
                if (allPlayerCells.includes(e.target.id)) {
                    let cell_id = e.target.id.split('-')
                    let x = cell_id[1]
                    let y = parseInt(cell_id[2])
                    if (canPlace.includes(e.target.id)) {
                        for (let i = 0; i < shipLength; i++) {
                            let z = y + i
                            document.getElementById('P' + '-' + x + '-' + z).classList.remove('outline')
                        }
                    } else {
                        if (y + shipLength > BOARD_WIDTH - 1) {
                            for (let i = 0; i < shipLength; i++) {
                                let z = BOARD_WIDTH - 2 - i
                                document.getElementById('P' + '-' + x + '-' + z).classList.remove('outline')
                            }
                        } else {
                            for (let i = 0; i < shipLength; i++) {
                                let z = y + i
                                document.getElementById('P' + '-' + x + '-' + z).classList.remove('prprpr')
                            }
                        }
                    }
                }
            }

            function PlaceShip(e) {
                if (canPlace.includes(e.target.id)) {
                    document.removeEventListener('mouseover', ShipOutline)
                    document.removeEventListener('mouseout', OutlineLeave)
                    document.removeEventListener('click', PlaceShip)

                    let cell_id = e.target.id.split('-')
                    let x = parseInt(cell_id[1])
                    let y = parseInt(cell_id[2])

                    for (let j = -1; j < shipLength + 1; j++) {
                        Player[x - 1][y + j] = 2
                        Player[x][y + j] = 2
                        Player[x + 1][y + j] = 2
                    }

                    for (let i = 0; i < shipLength; i++) {
                        Player[x][y + i] = 1
                    }


                    for (let i = 1; i < 11; i++) {
                        for (let j = 1; j < 11; j++) {
                            if (Player[i][j] == 1) {
                                document.getElementById('P' + '-' + i + '-' + j).classList.add('ship')
                                document.getElementById('P' + '-' + i + '-' + j).classList.remove('outline')
                            }
                        }
                    }

                    if (shipLength == 4) {
                        placed_ships_4 += 1
                        all_placed_ships += 1
                        document.getElementById('ship4_' + placed_ships_4).remove()
                    } else {
                        if (shipLength == 3) {
                            placed_ships_3 += 1
                            all_placed_ships += 1
                            document.getElementById('ship3_' + placed_ships_3).remove()
                        } else {
                            if (shipLength == 2) {
                                placed_ships_2 += 1
                                all_placed_ships += 1
                                document.getElementById('ship2_' + placed_ships_2).remove()
                            } else {
                                if (shipLength == 1) {
                                    placed_ships_1 += 1
                                    all_placed_ships += 1
                                    document.getElementById('ship1_' + placed_ships_1).remove()
                                }
                            }
                        }
                    }

                    if (all_placed_ships == ALL_SHIPS_MAX) {
                        let btn = document.createElement('button')
                        btn.setAttribute('id', 'btnGenerate')
                        btn.setAttribute('onclick', 'genBoard(); Game()')
                        btn.innerText = 'Rozpocznij'
                        document.getElementById('workSpace').append(btn)
                    }
                }


            }

            document.addEventListener('mouseover', ShipOutline)
            document.addEventListener('mouseout', OutlineLeave)
            document.addEventListener('click', PlaceShip)
        }



        function Game() {
            console.log('Trn równe', trn)
            if (trn % 2 == 0) {
                console.log('Twój Ruch')
                document.addEventListener('click', PlayerShoot)
            } else {
                console.log('Ruch Przeciwnika')
                BotShoot()
            }

            function PlayerShoot(e) {
                if (canPlayerShoot.includes(e.target.id)) {
                    let shot = e.target.id.split('-')
                    let x = parseInt(shot[0])
                    let y = parseInt(shot[1])
                    console.log('Strzeliłeś w pole', x + '-' + y)

                    if (board[x][y] == 1) {
                        board[x][y] = 4
                        console.log('Trafiłeś!')
                        playerWin++
                    } else {
                        board[x][y] = 3
                        console.log('Pudło')
                    }

                    for (let i = 1; i < 11; i++) {
                        for (let j = 1; j < 11; j++) {
                            if (board[i][j] == 4) {
                                document.getElementById(i + '-' + j).classList.add('outline')
                            } else {
                                if (board[i][j] == 3) {
                                    document.getElementById(i + '-' + j).classList.add('prprpr')
                                }
                            }
                        }
                    }

                    for (let i = 0; i < canPlayerShoot.length; i++) {
                        if (canPlayerShoot[i] === e.target.id) {
                            canPlayerShoot.splice(i, 1)
                        }
                    }

                    if (playerWin == SHOTS_TO_WIN) {
                        console.log('WYGRANA!')
                        setTimeout(() => {
                            document.getElementById('boardSpace').innerHTML = '<h1>WYGRAŁEŚ!</h1>'
                        }, 300)
                        setTimeout(rebuild, 1000)
                    } else {
                        trn += 1
                        setTimeout(Game, 1000)
                    }

                    document.removeEventListener('click', PlayerShoot)
                    document.getElementById('workSpace').innerHTML = '<h2>Ruch Przeciwnika</h2>'
                }
            }

            function BotShoot() {
                let myRand = Math.floor(Math.random() * canBotShoot.length)
                let shot = canBotShoot[myRand].split('-')
                let x = parseInt(shot[1])
                let y = parseInt(shot[2])
                console.log('Przeciwnik strzelił w pole', x + '-' + y)

                if (Player[x][y] == 1) {
                    Player[x][y] = 4
                    console.log('Trafił!')
                    botWin++
                } else {
                    Player[x][y] = 3
                    console.log('Pudło')
                }

                for (let i = 1; i < 11; i++) {
                    for (let j = 1; j < 11; j++) {
                        if (Player[i][j] == 4) {
                            document.getElementById('P' + '-' + i + '-' + j).classList.add('outline')
                            document.getElementById('P' + '-' + i + '-' + j).classList.remove('ship')
                        } else {
                            if (Player[i][j] == 3) {
                                document.getElementById('P' + '-' + i + '-' + j).classList.add('prprpr')
                            }
                        }
                    }
                }

                let index = canBotShoot.findIndex(checkField)
                canBotShoot.splice(index, 1)
                console.log(canBotShoot)

                function checkField(field) {
                    return field == 'P' + '-' + x + '-' + y
                }

                if (botWin == SHOTS_TO_WIN) {
                    console.log('WYGRANA!')
                    setTimeout(() => {
                        document.getElementById('boardSpace').innerHTML = '<h1>Przegrałeś :(</h1>'
                    }, 300)
                    setTimeout(rebuild, 1000)
                } else {
                    trn += 1
                    Game()
                }
            }

            function rebuild() {
                document.getElementById('workSpace').innerHTML = '<button id="btnStart" onclick="PlayerBoard()">GRAJ</button>'
                document.getElementById('boardSpace').innerHTML = `
                    <div id="plBoard" class="board"></div>
                    <div id="opBoard" class="board"></div>`
                document.getElementById('title').innerText = 'S.T.A.T.K.I'
            }

            document.getElementById('workSpace').innerHTML = '<h2>Twój Ruch</h2>'
        }

    </script>
    <h1 id="title">S.T.A.T.K.I</h1>
    <div id="workSpace">
        <button id="btnStart" onclick="PlayerBoard()">GRAJ</button>
    </div>
    <div id="PlayerShips"></div>

    <div id="boardSpace">
        <div id="plBoard" class="board"></div>
        <div id="opBoard" class="board"></div>
    </div>
</body>

</html>